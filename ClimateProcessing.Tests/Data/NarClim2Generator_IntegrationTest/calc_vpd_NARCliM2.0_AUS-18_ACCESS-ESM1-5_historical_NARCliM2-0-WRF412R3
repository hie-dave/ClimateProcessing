#!/usr/bin/env bash
#PBS -N calc_vpd_NARCliM2.0_AUS-18_ACCESS-ESM1-5_historical_NARCliM2-0-WRF412R3
#PBS -o @#OUTPUT_DIRECTORY#@/logs/calc_vpd_NARCliM2.0_AUS-18_ACCESS-ESM1-5_historical_NARCliM2-0-WRF412R3.log
#PBS -P 
#PBS -q normal
#PBS -l walltime=12:00:00
#PBS -l ncpus=1
#PBS -l mem=4GB
#PBS -l jobfs=128GB
#PBS -j oe

# This script was automatically generated. Do not modify.

# Exit immediately if any command fails.
set -euo pipefail

# Load required modules.
module purge
module load pbs netcdf cdo nco python3/3.12.1

# Create temporary directory and cd into it.
WORK_DIR="$(mktemp -d -p "${PBS_JOBFS}")"
cd "${WORK_DIR}"

# Delete the temporary directory on exit.
trap 'cd "${PBS_JOBFS}"; rm -rf "${WORK_DIR}"' EXIT

# Stream all output to a log file without buffering.
STREAM_FILE="@#OUTPUT_DIRECTORY#@/streams/calc_vpd_NARCliM2.0_AUS-18_ACCESS-ESM1-5_historical_NARCliM2-0-WRF412R3.log"
rm -f "${STREAM_FILE}"
exec 1> >(tee -a "${STREAM_FILE}") 2>&1

# Print a log message.
log() {
    echo "[$(date)] $*"
}

# File paths.
HUSS_FILE="@#OUTPUT_DIRECTORY#@/tmp/ACCESS-ESM1-5/historical/NARCliM2-0-WRF412R3/huss_AUS-18_ACCESS-ESM1-5_historical_r6i1p1f1_NSW-Government_NARCliM2-0-WRF412R3_v1-r1_mon_195101-195212.nc"
PS_FILE="@#OUTPUT_DIRECTORY#@/tmp/ACCESS-ESM1-5/historical/NARCliM2-0-WRF412R3/ps_AUS-18_ACCESS-ESM1-5_historical_r6i1p1f1_NSW-Government_NARCliM2-0-WRF412R3_v1-r1_mon_195101-195212.nc"
TAS_FILE="@#OUTPUT_DIRECTORY#@/tmp/ACCESS-ESM1-5/historical/NARCliM2-0-WRF412R3/tas_AUS-18_ACCESS-ESM1-5_historical_r6i1p1f1_NSW-Government_NARCliM2-0-WRF412R3_v1-r1_mon_195101-195212.nc"
OUT_FILE="@#OUTPUT_DIRECTORY#@/tmp/ACCESS-ESM1-5/historical/NARCliM2-0-WRF412R3/vpd_AUS-18_ACCESS-ESM1-5_historical_r6i1p1f1_NSW-Government_NARCliM2-0-WRF412R3_v1-r1_mon_195101-195212.nc"
EQN_FILE="${WORK_DIR}/vpd_equations.txt"

# Generate equation file.
log "Generating VPD equation file..."
cat >"${EQN_FILE}" <<EOF
# Saturation vapor pressure (Pa) (tas in degC)
_esat=0.611*exp((17.27*tas)/(tas+237.3))*1000;
# Actual vapor pressure (Pa)
_e=(huss*ps)/(0.622+0.378*huss);
# VPD (kPa)
vpd=(_esat-_e)/1000;
EOF

# Calculate VPD.
log "Calculating VPD..."
cdo -L -O -v -z zip1 exprf,"${EQN_FILE}" -merge "${HUSS_FILE}" "${PS_FILE}" "${TAS_FILE}" "${OUT_FILE}"
log "VPD calculation completed successfully."
